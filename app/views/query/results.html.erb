<h3><%= @table.to_s.titleize %> Search Results</h3>

<p>Found <%= pluralize @res.count, "match" %>:</p>

<%= will_paginate @res %>

<div class="search_results table-responsive">
  <div class="pull-right">
    <%= link_to query_results_path(params_hash, format: "csv") do %>
      <button type="button" class="btn btn-default">
        Download as CSV <span class="glyphicon glyphicon-download-alt"></span>
      </button>
    <% end %>
  </div>

  <table class="table table-striped">
    <% no_occupation = !@column_names.include?("occupation_id") %>
    <tr>
      <%# Add Occupation column if not present %>
      <% if @occupation_source.present? && no_occupation %>
        <th><%= @occupation_source %></th>
      <% end -%>

      <%- @column_names.each do |column| %>
        <% unless column[/(?:^id|_at)$/] || sensitive_record?(column) %>
          <th>
            <% if column == "occupation_id" && @occupation_source.present? %>
              <%= @occupation_source %>
            <% else %>
              <%= column.titleize %>
            <% end %>
          </th>
        <% end %>
      <% end %>
    </tr>
    <% @res.each do |result| %>
      <tr>
        <%# Add Occupation column if not present %>
        <% if @occupation_source.present? && no_occupation %>
          <td>
            <%= Occupation.where(id: result[:occupation_id]).first.name %>
          </td>
        <% end -%>

        <%- @column_names.each do |column| %>
          <% if sensitive_record?(column) %>
            <%# Display nothing %>
          <% elsif column[/_id$/] %>
            <td>
              <% assoc_col = column[/^(.+)_id$/, 1] %>
              <% if assoc_col == "occupation" %>
                <%= Occupation.where(id: result[:occupation_id]).first.name %>
              <% elsif result.respond_to?(assoc_col) %>
                <% if result.send(assoc_col).present? %>
                  <% if result.send(assoc_col).respond_to?(:name) %>
                    <%= result.send(assoc_col).name %>
                  <% else %>
                    <%= result.send(assoc_col).id %>
                  <% end %>
                <% else %>
                  N/A
                <% end %>
              <% elsif result.respond_to?(assoc_col.pluralize) %>
                <% if result.send(assoc_col.pluralize).present? %>
                  <% assoc_obj = result.send(assoc_col.pluralize) %>
                  <% if assoc_obj.first.respond_to?("name") %>
                    <%= assoc_obj.map { |r| r.name }.join("; ") %>
                  <% elsif assoc_obj.first.respond_to?(assoc_col << "_no") %>
                    <%= assoc_obj.map { |r| r.send(assoc_col << "_no") }
                          .join("; ")
                    %>
                  <% elsif assoc_obj.first.respond_to?("id") %>
                    <%= assoc_obj.map { |r| r.id }.join("; ") %>
                  <% end %>
                <% else %>
                  N/A
                <% end %>
              <% else %>
                N/A
              <% end %>
            </td>
          <% elsif !column[/(?:^id|_at)$/] %>
            <td><%= result[column] %></td>
          <% end %>
        <% end %>
      </tr>
    <% end %>
  </table>

  <%= will_paginate @res %>
  <div class="pull-right">
    <%= link_to query_results_path(params_hash, format: "csv") do %>
      <button type="button" class="btn btn-default">
        Download as CSV <span class="glyphicon glyphicon-download-alt"></span>
      </button>
    <% end %>
  </div>
</div>

<%= will_paginate @res %>
